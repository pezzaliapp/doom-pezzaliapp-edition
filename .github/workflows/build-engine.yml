name: Build Chocolate Doom (WASM) -> /engine

on:
  workflow_dispatch:
  push:
    paths:
      - ".github/workflows/build-engine.yml"

permissions:
  contents: write

concurrency:
  group: build-engine
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Emscripten SDK
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: latest

      - name: Install autotools
        run: |
          sudo apt-get update
          sudo apt-get install -y autoconf automake libtool pkg-config

      - name: Clone Chocolate Doom
        run: git clone --depth=1 https://github.com/chocolate-doom/chocolate-doom.git

      - name: Bootstrap (autoreconf)
        working-directory: chocolate-doom
        run: autoreconf -fiv

      - name: Configure (Emscripten)
        working-directory: chocolate-doom
        env:
          CC: emcc
          CXX: em++
          AR: emar
          RANLIB: emranlib
          CFLAGS: "-sUSE_SDL=2 -sALLOW_MEMORY_GROWTH=1"
          CXXFLAGS: "-sUSE_SDL=2 -sALLOW_MEMORY_GROWTH=1"
          LDFLAGS: "-sUSE_SDL=2 -sALLOW_MEMORY_GROWTH=1"
          ac_cv_func_malloc_0_nonnull: "yes"
          ac_cv_func_realloc_0_nonnull: "yes"
          SDL2_CONFIG: ""
        run: |
          emconfigure ./configure --disable-opengl --host=wasm32-unknown-emscripten

      - name: Build (doom target)
        working-directory: chocolate-doom
        run: |
          emmake make -j2 -C src/doom

      - name: Locate wasm/js artifacts
        id: out
        shell: bash
        run: |
          set -e
          JS=$(find chocolate-doom/src/doom -type f -name "*.js"   | head -n1 || true)
          WASM=$(find chocolate-doom/src/doom -type f -name "*.wasm"| head -n1 || true)
          echo "Found JS:   $JS"
          echo "Found WASM: $WASM"
          echo "js=$JS"     >> "$GITHUB_OUTPUT"
          echo "wasm=$WASM" >> "$GITHUB_OUTPUT"
          test -n "$JS" && test -n "$WASM"

      - name: Copy to /engine (repo root)
        run: |
          mkdir -p engine
          cp "${{ steps.out.outputs.js }}"   engine/engine.js
          cp "${{ steps.out.outputs.wasm }}" engine/engine.wasm
          ls -lh engine/

      - name: Commit updated engine
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add engine/engine.js engine/engine.wasm
          if git diff --cached --quiet; then
            echo "No changes"; exit 0; fi
          git commit -m "Update engine (Chocolate Doom, wasm)"
          git push
